<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IZS BIOINFORMATICS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Roboto+Mono:wght@300;400&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #01679c;
            --secondary: #f2f2f3;
            --background: #ffffff;
            --text: #333333;
            --text-light: #666666;
            --border: #e0e0e0;
            --success: #10b981;
            --error: #ef4444;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .main-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 0;
            position: relative;
        }

        .results-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            height: 100vh;
            gap: 1px;
            background-color: var(--border);
            overflow: hidden;
        }

        @media (max-width: 1024px) {
            .results-container {
                grid-template-columns: 1fr;
            }
        }

        .result-panel {
            background-color: var(--background);
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .panel-header {
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--background);
            border-radius: 2.4rem 2.4rem 0 0;
        }

        .panel-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 15px;
            font-weight: 600;
            color: var(--primary);
        }

        .panel-title i {
            font-size: 18px;
        }

        .panel-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-light);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--text-light);
        }

        .status-dot.active {
            background-color: var(--success);
        }

        .status-dot.error {
            background-color: var(--error);
        }

        .panel-content {
            flex: 1;
            overflow: hidden;
            position: relative;
            border-radius: 0 0 2.4rem 2.4rem;
        }

        #nextflowCode {
            width: 100%;
            height: 100%;
            padding: 20px;
            padding-bottom: 250px; 
            background-color: var(--background);
            color: var(--text);
            font-family: 'Roboto Mono', monospace;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre;
            overflow: auto;
            border: none;
            resize: none;
            border-radius: 0 0 2.4rem 2.4rem;
        }

        #mermaidContainer {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background-color: var(--background);
            position: relative;
            cursor: grab;
            border-radius: 0 0 2.4rem 2.4rem;
        }

        #mermaidContainer.dragging {
            cursor: grabbing;
            user-select: none;
        }

        #mermaidDiagram {
            width: 100%;
            height: 100%;
            min-width: 100%;
            min-height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
            overflow: visible;
        }

        #mermaidDiagram svg {
            width: 100% !important;
            height: 100% !important;
            max-width: 100% !important;
            max-height: 100% !important;
            display: block;
            transition: transform 0.3s ease;
        }

        .zoom-controls {
            position: absolute;
            top: 16px;
            right: 16px;
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 6px;
            background-color: var(--background);
            border-radius: 1.2rem;
            padding: 8px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .zoom-btn {
            background-color: var(--background);
            border: 1px solid var(--border);
            color: var(--text);
            width: 32px;
            height: 32px;
            border-radius: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .zoom-btn:hover {
            background-color: var(--secondary);
            border-color: var(--primary);
        }

        .zoom-btn.reset {
            background-color: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .zoom-btn.reset:hover {
            background-color: #015a8a;
        }

        .zoom-btn.pan.active {
            background-color: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .zoom-level {
            color: var(--text-light);
            font-size: 12px;
            text-align: center;
            margin-top: 4px;
            font-family: 'Roboto Mono', monospace;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-light);
            text-align: center;
            padding: 48px;
        }

        .empty-state i {
            font-size: 56px;
            margin-bottom: 20px;
            opacity: 0.5;
            color: var(--primary);
        }

        .empty-state h3 {
            font-size: 18px;
            margin-bottom: 12px;
            color: var(--text);
            font-weight: 600;
        }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid rgba(1, 103, 156, 0.1);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .chat-dialog {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 48px);
            max-width: 1200px;
            background-color: var(--background);
            border-radius: 2.4rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            padding: 10px 20px;
            gap: 6px;
        }

        .dialog-header {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .dialog-title {
            margin: 0px 10px;
            font-size: 14px;
            font-weight: 600;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dialog-title i {
            font-size: 16px;
        }

        .examples-container {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 8px 0;
            scrollbar-width: thin;
        }

        .examples-container::-webkit-scrollbar {
            height: 4px;
        }

        .examples-container::-webkit-scrollbar-track {
            background: var(--secondary);
            border-radius: 2px;
        }

        .examples-container::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 2px;
        }

        .example-btn {
            background-color: var(--secondary);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 10px 16px;
            border-radius: 1.6rem;
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .example-btn:hover {
            background-color: rgba(1, 103, 156, 0.1);
            border-color: var(--primary);
            color: var(--primary);
        }

        .input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        #userInput {
            flex: 1;
            padding: 10px 15px;
            background-color: var(--secondary);
            border: 1px solid var(--border);
            border-radius: 2rem;
            color: var(--text);
            font-family: 'Inter', sans-serif;
            font-size: 15px;
            resize: none;
            min-height: 56px;
            max-height: 85px;
            transition: all 0.2s;
            line-height: 1.5;
        }

        #userInput:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(1, 103, 156, 0.1);
        }

        #userInput::placeholder {
            color: var(--text-light);
        }

        #generateBtn {
            background-color: var(--primary);
            color: white;
            border: none;
            width: 46px;
            height: 46px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 20px;
        }

        #generateBtn:hover {
            background-color: #015a8a;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(1, 103, 156, 0.2);
        }

        #generateBtn:active {
            transform: translateY(0);
        }

        #generateBtn:disabled {
            background-color: var(--border);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .dialog-footer {
            display: none; /* flex */
            align-items: center;
            justify-content: space-between;
            padding-top: 8px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: var(--text-light);
        }

        .error-message {
            background-color: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
            padding: 14px;
            border-radius: 1.2rem;
            font-size: 14px;
            display: none;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="results-container">
            <div class="result-panel">
                <div class="panel-header">
                    <div class="panel-title">
                        <i class="fas fa-code"></i>
                        <span>Nextflow Code</span>
                    </div>
                    <div class="panel-status">
                        <div class="status-dot" id="nextflowStatus"></div>
                        <span>Ready</span>
                    </div>
                </div>
                <div class="panel-content">
                    <div class="empty-state" id="nextflowEmpty">
                        <i class="fas fa-file-code"></i>
                        <h3>Nextflow Code</h3>
                        <p>Generated code will appear here</p>
                    </div>
                    <div class="loading" id="nextflowLoading" style="display: none;">
                        <div class="spinner"></div>
                        <p>Generating Nextflow Code...</p>
                    </div>
                    <textarea id="nextflowCode" readonly style="display: none;"></textarea>
                </div>
            </div>

            <div class="result-panel">
                <div class="panel-header">
                    <div class="panel-title">
                        <i class="fas fa-project-diagram"></i>
                        <span>Mermaid Diagram</span>
                    </div>
                    <div class="panel-status">
                        <div class="status-dot" id="mermaidStatus"></div>
                        <span>Ready</span>
                    </div>
                </div>
                <div class="panel-content">
                    <div class="empty-state" id="mermaidEmpty">
                        <i class="fas fa-diagram-project"></i>
                        <h3>Mermaid Diagram</h3>
                        <p>Workflow visualization will appear here</p>
                    </div>
                    <div class="loading" id="mermaidLoading" style="display: none;">
                        <div class="spinner"></div>
                        <p>Generating Mermaid...</p>
                    </div>
                    <div id="mermaidContainer" style="display: none;">
                        <div id="mermaidDiagram"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="chat-dialog">
            <div class="dialog-header">
                <div class="examples-container">
                    <div class="dialog-title">
                        <i class="fas fa-lightbulb"></i>
                    </div>
                    <button class="example-btn" data-example="Design a sequential bioinformatics workflow for the Covid Emergency pipeline that starts with trimmed FASTQ reads and the SARS-CoV-2 reference genome (NC_045512.2, Wuhan-Hu-1). The pipeline should: 1. Map the reads to the reference and call variants using iVar, producing a consensus FASTA sequence. 2. Pass that consensus FASTA directly to Pangolin to assign a viral lineage. 3. Output the final Pangolin lineage report (CSV) and retain the consensus FASTA.">Covid Emergency</button>
                    <button class="example-btn" data-example="Design a Nextflow workflow for segmented viruses that takes pre-processed FASTQ reads and user-provided reference genomes, maps reads to each reference using iVar, and outputs per-segment consensus FASTA files plus a consolidated multifasta. The workflow should pair each sample with all references using and be structured as a reusable module.">Mapping for Segmented Viruses</button>
                    <button class="example-btn" data-example="Design a Nextflow workflow for a 'Depletion & de novo' pipeline that starts with trimmed FASTQ reads and an optional host reference genome. The workflow first removes host reads using Bowtie, then performs de novo assembly of the depleted (or original, if no host provided) reads with SPAdes. The pipeline supports samples with or without a host reference and emits both the depleted reads and final assemblies.">Depletion and de novo</button>
                    <button class="example-btn" data-example="Design a Nextflow workflow for the 'Genome Draft' pipeline that processes depleted FASTQ reads against a provided reference genome in parallel:1. Run Bowtie2 mapping to produce a coverage-checked consensus FASTA. 2. Simultaneously run iVar-based mapping to generate another consensus FASTA, which is then passed—along with an optional GenBank reference—to Prokka for structural gene annotation (configured for viral genomes). The workflow accepts FASTA reference(s) for mapping and an optional GenBank reference for annotation, and executes both mapping branches concurrently before proceeding to annotation.">Genome Draft</button>
                    <button class="example-btn" data-example="Design a Nextflow DSL2 workflow for the WNV Lineage Calculation and Mapping pipeline that starts with trimmed FASTQ reads and: 1. Determines the West Nile virus lineage using the Westnile tool. 2. Uses the inferred lineage to dynamically select the matching reference genome via getReferenceForLineage. 3. Performs read mapping and variant calling with iVar using the lineage-specific reference. The workflow outputs a consensus sequence (FASTA) and a VCF file, enabling lineage-aware, reference-guided analysis of WNV samples in a fully automated, sequential manner.">West Nile Virus</button>
                    <button class="example-btn" data-example="Design a Nextflow DSL2 workflow for the 'Filtering & de novo' pipeline that starts with trimmed FASTQ reads and a user-provided reference genome: 1. Filters reads using Bowtie to retain only those aligning to the reference. 2. Performs de novo assembly of the filtered reads with SPAdes. The workflow outputs both the filtered reads and the final assembled contigs, enabling reference-guided enrichment followed by assembly.">Filtering and de novo</button>
                </div>
            </div>

            <div class="input-wrapper">
                <textarea id="userInput" placeholder="Input your description, for example: Design a sequential bioinformatics workflow for the Covid Emergency pipeline that ..."></textarea>
                <button id="generateBtn">
                    <i class="fas fa-arrow-up"></i>
                </button>
            </div>

            <div class="error-message" id="errorMessage">
                <i class="fas fa-exclamation-circle"></i> <span id="errorText"></span>
            </div>

            <div class="dialog-footer">
                <div class="status-indicator">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">Ready</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Mermaid with updated configuration
        mermaid.initialize({
            startOnLoad: false,
            theme: 'default',
            flowchart: {
                useMaxWidth: false,
                htmlLabels: true,
                curve: 'basis'
            },
            securityLevel: 'loose',
            themeCSS: `
                .node rect, .node circle, .node ellipse, .node polygon, .node path {
                    fill: #ffffff !important;
                    stroke: #01679c !important;
                    stroke-width: 2px !important;
                }
                
                .cluster rect {
                    fill: #f2f2f3 !important;
                    stroke: #015a8a !important;
                    stroke-width: 1.5px !important;
                }
                
                .edgePath .path {
                    stroke: #01679c !important;
                    stroke-width: 2px !important;
                }
                
                .arrowheadPath {
                    fill: #01679c !important;
                    stroke: #01679c !important;
                }
                
                .nodeLabel {
                    color: #333333 !important;
                    font-family: 'Inter', sans-serif !important;
                }
                
                .edgeLabel {
                    background-color: #ffffff !important;
                    color: #666666 !important;
                    font-family: 'Inter', sans-serif !important;
                    border: 1px solid #e0e0e0 !important;
                    border-radius: 4px !important;
                    padding: 2px 6px !important;
                }
                
                .node.clickable rect {
                    stroke-width: 3px !important;
                }
                
                .node.start rect, .node.end rect {
                    stroke: #10b981 !important;
                }
                
                .node.diamond rect {
                    stroke: #e535ab !important;
                }
                
                svg {
                    width: 100% !important;
                    height: 100% !important;
                    max-width: 100% !important;
                    max-height: 100% !important;
                }
            `
        });

        // DOM elements
        const userInput = document.getElementById('userInput');
        const generateBtn = document.getElementById('generateBtn');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        
        const nextflowEmpty = document.getElementById('nextflowEmpty');
        const nextflowLoading = document.getElementById('nextflowLoading');
        const nextflowCode = document.getElementById('nextflowCode');
        const nextflowStatus = document.getElementById('nextflowStatus');
        
        const mermaidEmpty = document.getElementById('mermaidEmpty');
        const mermaidLoading = document.getElementById('mermaidLoading');
        const mermaidContainer = document.getElementById('mermaidContainer');
        const mermaidDiagram = document.getElementById('mermaidDiagram');
        const mermaidStatus = document.getElementById('mermaidStatus');
        
        const exampleBtns = document.querySelectorAll('.example-btn');
        const apiUrl = 'https://izs-llm.me/generate';

        // Drag and scale related variables
        let currentScale = 1;
        const MIN_SCALE = 0.2;
        const MAX_SCALE = 3;
        const SCALE_STEP = 0.2;
        
        // Drag related variables
        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let translateX = 0;
        let translateY = 0;
        let isPanMode = false;

        // Set status
        function setStatus(type, message) {
            statusDot.className = 'status-dot';
            statusDot.classList.add(type);
            statusText.textContent = message;
        }

        // Show error
        function showError(message) {
            errorText.textContent = message;
            errorMessage.style.display = 'block';
            setStatus('error', 'Error');
        }

        // Hide error
        function hideError() {
            errorMessage.style.display = 'none';
        }

        // Reset result areas
        function resetResults() {
            // Hide all content
            nextflowEmpty.style.display = 'none';
            nextflowLoading.style.display = 'none';
            nextflowCode.style.display = 'none';
            
            mermaidEmpty.style.display = 'none';
            mermaidLoading.style.display = 'none';
            mermaidContainer.style.display = 'none';
            
            // Reset status indicators
            nextflowStatus.className = 'status-dot';
            nextflowStatus.nextElementSibling.textContent = 'Ready';
            
            mermaidStatus.className = 'status-dot';
            mermaidStatus.nextElementSibling.textContent = 'Ready';
        }

        // Show loading state
        function showLoading() {
            resetResults();
            
            nextflowLoading.style.display = 'flex';
            mermaidLoading.style.display = 'flex';
            
            nextflowStatus.className = 'status-dot active';
            nextflowStatus.nextElementSibling.textContent = 'Generating...';
            
            mermaidStatus.className = 'status-dot active';
            mermaidStatus.nextElementSibling.textContent = 'Generating...';
        }

        // Show Nextflow code
        function showNextflowCode(code) {
            nextflowLoading.style.display = 'none';
            nextflowCode.textContent = code;
            nextflowCode.style.display = 'block';
            nextflowStatus.className = 'status-dot active';
            nextflowStatus.nextElementSibling.textContent = 'Generated';
            
            // Auto scroll to top
            nextflowCode.scrollTop = 0;
        }

        // Generate scale toolbar
        function createZoomControls() {
            const zoomControls = document.createElement('div');
            zoomControls.className = 'zoom-controls';
            
            // Drag
            const panBtn = document.createElement('button');
            panBtn.className = 'zoom-btn pan';
            panBtn.innerHTML = '<i class="fas fa-hand-paper"></i>';
            panBtn.title = 'Drag and drop mode (spacebar)';
            panBtn.addEventListener('click', togglePanMode);
            
            // Zoom in
            const zoomInBtn = document.createElement('button');
            zoomInBtn.className = 'zoom-btn';
            zoomInBtn.innerHTML = '<i class="fas fa-search-plus"></i>';
            zoomInBtn.title = 'Zoom in (Ctrl + +)';
            zoomInBtn.addEventListener('click', () => zoomChart(SCALE_STEP));
            
            // Zoom out
            const zoomOutBtn = document.createElement('button');
            zoomOutBtn.className = 'zoom-btn';
            zoomOutBtn.innerHTML = '<i class="fas fa-search-minus"></i>';
            zoomOutBtn.title = 'Zoom out (Ctrl + -)';
            zoomOutBtn.addEventListener('click', () => zoomChart(-SCALE_STEP));
            
            // Reset
            const resetBtn = document.createElement('button');
            resetBtn.className = 'zoom-btn reset';
            resetBtn.innerHTML = '<i class="fas fa-expand-alt"></i>';
            resetBtn.title = 'Reset (Ctrl + 0)';
            resetBtn.addEventListener('click', resetView);
            
            // Zoom level
            const zoomLevel = document.createElement('div');
            zoomLevel.className = 'zoom-level';
            zoomLevel.id = 'zoomLevel';
            zoomLevel.textContent = '100%';
            
            zoomControls.appendChild(panBtn);
            zoomControls.appendChild(zoomInBtn);
            zoomControls.appendChild(zoomOutBtn);
            zoomControls.appendChild(resetBtn);
            zoomControls.appendChild(zoomLevel);
            
            return zoomControls;
        }

        // Drag mode
        function togglePanMode() {
            isPanMode = !isPanMode;
            const panBtn = document.querySelector('.zoom-btn.pan');
            if (panBtn) {
                if (isPanMode) {
                    panBtn.classList.add('active');
                    panBtn.title = 'Drag mode on (spacebar) - Click to turn off';
                    mermaidContainer.style.cursor = 'grab';
                } else {
                    panBtn.classList.remove('active');
                    panBtn.title = 'Drag mode off (spacebar) - Click to turn on';
                    mermaidContainer.style.cursor = 'default';
                }
            }
        }

        // Initialize dragging 
        function initDragEvents() {
            const svgElement = mermaidDiagram.querySelector('svg');
            if (!svgElement) return;

            // Mouse press
            mermaidContainer.addEventListener('mousedown', (e) => {
                if (isPanMode || e.which === 2 || e.which === 1) {
                    e.preventDefault();
                    isDragging = true;
                    mermaidContainer.classList.add('dragging');
                    dragStartX = e.clientX - translateX;
                    dragStartY = e.clientY - translateY;
                }
            });

            mermaidContainer.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                e.preventDefault();
                
                translateX = e.clientX - dragStartX;
                translateY = e.clientY - dragStartY;
                
                applyTransform();
            });

            mermaidContainer.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    mermaidContainer.classList.remove('dragging');
                }
            });

            mermaidContainer.addEventListener('mouseleave', () => {
                if (isDragging) {
                    isDragging = false;
                    mermaidContainer.classList.remove('dragging');
                }
            });

            mermaidContainer.addEventListener('dragstart', (e) => {
                e.preventDefault();
            });
        }

        function applyTransform() {
            const svgElement = mermaidDiagram.querySelector('svg');
            if (!svgElement) return;
            
            svgElement.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentScale})`;
            svgElement.style.transformOrigin = 'center center';
            
            updateZoomLevel();
        }

        // Zoom chart
        function zoomChart(delta) {
            const svgElement = mermaidDiagram.querySelector('svg');
            if (!svgElement) return;
            
            let newScale = currentScale + delta;
            
            if (newScale < MIN_SCALE) newScale = MIN_SCALE;
            if (newScale > MAX_SCALE) newScale = MAX_SCALE;
            
            currentScale = newScale;
            applyTransform();
        }

        // Reset view (zoom and pan)
        function resetView() {
            const svgElement = mermaidDiagram.querySelector('svg');
            if (!svgElement) return;
            
            currentScale = 1;
            translateX = 0;
            translateY = 0;
            applyTransform();
        }

        // Update zoom level display
        function updateZoomLevel() {
            const zoomLevelElement = document.getElementById('zoomLevel');
            if (zoomLevelElement) {
                zoomLevelElement.textContent = `${Math.round(currentScale * 100)}%`;
            }
        }

        // Handling keyboard shortcuts
        function handleKeyboardShortcuts(e) {
            
            if (!mermaidContainer.style.display || mermaidContainer.style.display === 'none') {
                return;
            }
            
            if (e.key === ' ') {
                e.preventDefault();
                togglePanMode();
            }
            
            else if (e.ctrlKey && (e.key === '+' || e.key === '=')) {
                e.preventDefault();
                zoomChart(SCALE_STEP);
            }
            
            else if (e.ctrlKey && e.key === '-') {
                e.preventDefault();
                zoomChart(-SCALE_STEP);
            }
            
            else if (e.ctrlKey && e.key === '0') {
                e.preventDefault();
                resetView();
            }
        }

        // Render Mermaid diagram with enhanced styling
        function renderMermaid(code) {
            mermaidLoading.style.display = 'none';
            mermaidContainer.style.display = 'flex';
            mermaidStatus.className = 'status-dot active';
            mermaidStatus.nextElementSibling.textContent = 'Generated';
            
            mermaidDiagram.innerHTML = '';
            
            const oldZoomControls = mermaidDiagram.querySelector('.zoom-controls');
            if (oldZoomControls) {
                oldZoomControls.remove();
            }
            
            try {
                
                mermaidDiagram.innerHTML = `<div class="mermaid">${code}</div>`;
                
                mermaid.init(undefined, mermaidDiagram.querySelector('.mermaid'));
                
                setTimeout(() => {
                    const svgElement = mermaidDiagram.querySelector('svg');
                    if (svgElement) {
                        
                        const zoomControls = createZoomControls();
                        mermaidDiagram.appendChild(zoomControls);
                        
                        resetView();
                        
                        initDragEvents();
                        
                        mermaidContainer.addEventListener('wheel', (e) => {
                            if (e.ctrlKey) {
                                e.preventDefault();
                                const delta = e.deltaY > 0 ? -SCALE_STEP/2 : SCALE_STEP/2;
                                zoomChart(delta);
                            }
                        });
                    }
                }, 100);
            } catch (err) {
                console.error('Mermaid rendering error:', err);
                mermaidDiagram.innerHTML = `
                    <div style="color: #ef4444; text-align: center; padding: 40px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 20px;"></i>
                        <h3>Flowchart rendering failed</h3>
                        <p>${err.message}</p>
                    </div>
                `;
            }
        }

        // Handle API response
        function handleApiResponse(data) {
            hideError();
            
            if (data.status === 'success') {
                setStatus('active', 'Generation successful');
                
                // Show Nextflow code
                if (data.nextflow_code) {
                    showNextflowCode(data.nextflow_code);
                } else {
                    showNextflowCode('// Nextflow code not generated');
                }
                
                // Show Mermaid diagram
                if (data.mermaid_code) {
                    renderMermaid(data.mermaid_code);
                } else {
                    renderMermaid(`graph TD
    A[No Mermaid code generated] --> B[Please check API response]
    style A fill:#ffffff,stroke:#ef4444,stroke-width:3px
    style B fill:#ffffff,stroke:#01679c,stroke-width:2px`);
                }
            } else {
                setStatus('error', 'API returned error');
                showError(`API returned status: ${data.status || 'Unknown error'}`);
                
                // Show error placeholder
                showNextflowCode(`// API returned error status: ${JSON.stringify(data, null, 2)}`);
                renderMermaid(`graph TD
    A[API returned error] --> B[Status: ${data.status || 'Unknown'}]
    style A fill:#ffffff,stroke:#ef4444,stroke-width:3px
    style B fill:#ffffff,stroke:#ef4444,stroke-width:2px`);
            }
        }

        // Call API - using GraphQL format
        async function callApi(userText) {
            try {
                setStatus('active', 'Calling API...');
                showLoading();
                
                // Build GraphQL query
                const graphqlQuery = {
                    query: userText,
                };

                console.log('Sending GraphQL request:', JSON.stringify(graphqlQuery, null, 2));
                
                let response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(graphqlQuery)
                });
                
                
                if (!response.ok) {
                    throw new Error(`HTTP error: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('API response:', data);
                
                // Check GraphQL response structure
                if (data.errors) {
                    throw new Error(`GraphQL error: ${JSON.stringify(data.errors)}`);
                }
                
                // Extract data - adjust according to GraphQL response structure
                let resultData;
                if (data.data && data.data.generate) {
                    resultData = data.data.generate;
                } else if (data.status) {
                    // Directly returned the required data structure
                    resultData = data;
                } else {
                    throw new Error('Unable to parse API response structure');
                }
                
                handleApiResponse(resultData);
                
            } catch (error) {
                console.error('API call error:', error);
                setStatus('error', 'API call failed');
                showError(`API call failed: ${error.message}`);
                
                // Show mock data for demonstration
                setTimeout(() => {
                    const mockData = {
                        status: 'success',
                        nextflow_code: `nextflow.enable.dsl=2

// --- IMPORTS ---

include { step_2AS_mapping__ivar } from '../steps/step_2AS_mapping__ivar'

include { step_4TY_lineage__pangolin } from '../steps/step_4TY_lineage__pangolin'

include { extractKey } from '../functions/common.nf'

include { getSingleInput } from '../functions/parameters.nf'

// --- GLOBALS ---

    
def referenceCode = "NC_045512.2"
    

    
def referencePath = "{params.assets_dir}/module_covid_emergency/NC_045512.fasta"
    

    
def referenceRiscd = "220308-020220308005121273-2AS_import-external"
    

// --- INLINE PROCESSES (Custom Scripts) ---

// --- MAIN WORKFLOW MODULE ---

// --- HELPER SUB-WORKFLOWS ---

// --- MAIN WORKFLOW MODULE ---

workflow module_covid_emergency {
    
    take: 
        
        trimmed
        
    

    main:

        trimmed.multiMap {
            trimmed: it
            reference: [ referenceRiscd, referenceCode, file(referencePath) ]
            
        } .set { trAndRef }

        ivar_out = step_2AS_mapping__ivar(trAndRef.trimmed, trAndRef.reference)

        step_4TY_lineage__pangolin(ivar_out.consensus)

    
}

// --- ENTRYPOINT WORKFLOW ---
workflow {

    module_covid_emergency(getSingleInput())

}`,
                        mermaid_code: `flowchart TD
    classDef process fill:#e1f5fe,stroke:#01579b,stroke-width:2px;
    classDef subworkflow fill:#e8eaf6,stroke:#3f51b5,stroke-width:2px,stroke-dasharray: 5 5;
    classDef operator fill:#fff9c4,stroke:#fbc02d,stroke-width:2px,stroke-dasharray: 5 5;
    classDef data fill:#e0e0e0,stroke:#333,stroke-width:2px;
    classDef global fill:#f3e5f5,stroke:#7b1fa2,stroke-width:1px;
    Var_trimmed(["trimmed"]):::data
    subgraph main_scope ["Main Workflow"]
    direction TB
    op_trimmed_0{{"multiMap"}}:::operator
    Var_trimmed --> op_trimmed_0
    Glob_referenceRiscd -.-> op_trimmed_0
    Glob_referenceCode -.-> op_trimmed_0
    Glob_referencePath -.-> op_trimmed_0
    Var_trAndRef_op_trimmed_0(("trAndRef")):::data
    op_trimmed_0 --> Var_trAndRef_op_trimmed_0
    proc_step_2AS_mapping__ivar["step_2AS_mapping__ivar"]:::process
    Var_trAndRef_op_trimmed_0 -- ".trimmed" --> proc_step_2AS_mapping__ivar
    Var_trAndRef_op_trimmed_0 -- ".reference" --> proc_step_2AS_mapping__ivar
    Var_ivar_out_proc_step_2AS_mapping__ivar(("ivar_out")):::data
    proc_step_2AS_mapping__ivar --> Var_ivar_out_proc_step_2AS_mapping__ivar
    node_cae3db["step_4TY_lineage__pangolin"]:::process
    Var_ivar_out_proc_step_2AS_mapping__ivar -- ".consensus" --> node_cae3db
    end
    subgraph entrypoint_scope ["Entrypoint"]
    proc_module_covid_emergency["module_covid_emergency"]:::process
    end`
                    };
                    handleApiResponse(mockData);
                }, 1500);
            }
        }

        // Generate button click event
        generateBtn.addEventListener('click', () => {
            const text = userInput.value.trim();
            
            if (!text) {
                showError('Please enter a workflow description');
                return;
            }
            
            hideError();
            callApi(text);
        });

        // Example button click event
        exampleBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const exampleText = btn.getAttribute('data-example');
                userInput.value = exampleText;
                userInput.focus();
                
                // Auto-resize textarea
                userInput.style.height = 'auto';
                userInput.style.height = userInput.scrollHeight + 'px';
            });
        });

        // Input box Enter key (Ctrl+Enter) to send
        userInput.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                generateBtn.click();
            }
            
            // Auto-resize textarea
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                generateBtn.click();
            }
        });

        // Auto-resize textarea on input
        userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
        });

        document.addEventListener('keydown', handleKeyboardShortcuts);

        // Initialize page
        resetResults();
        setStatus('', 'Ready');
        
        // Display some initial content when page loads
        window.addEventListener('load', () => {
            console.log('IZS AI workflow generator loaded');
        });
    </script>
</body>
</html>